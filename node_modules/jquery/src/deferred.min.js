define(["./core","./var/isFunction","./var/slice","./callbacks"],function(c,e,d){function a(g){return g}function f(g){throw g}function b(j,i,h,g){var k;try{if(j&&e((k=j.promise))){k.call(j).done(i).fail(h)}else{if(j&&e((k=j.then))){k.call(j,i,h)}else{i.apply(undefined,[j].slice(g))}}}catch(j){h.apply(undefined,[j])}}c.extend({Deferred:function(i){var h=[["notify","progress",c.Callbacks("memory"),c.Callbacks("memory"),2],["resolve","done",c.Callbacks("once memory"),c.Callbacks("once memory"),0,"resolved"],["reject","fail",c.Callbacks("once memory"),c.Callbacks("once memory"),1,"rejected"]],j="pending",k={state:function(){return j},always:function(){g.done(arguments).fail(arguments);return this},"catch":function(l){return k.then(null,l)},pipe:function(){var l=arguments;return c.Deferred(function(m){c.each(h,function(o,n){var p=e(l[n[4]])&&l[n[4]];g[n[1]](function(){var q=p&&p.apply(this,arguments);if(q&&e(q.promise)){q.promise().progress(m.notify).done(m.resolve).fail(m.reject)}else{m[n[0]+"With"](this,p?[q]:arguments)}})});l=null}).promise()},then:function(o,l,n){var p=0;function m(t,q,s,r){return function(){var v=this,u=arguments,w=function(){var y,z;if(t<p){return}y=s.apply(v,u);if(y===q.promise()){throw new TypeError("Thenable self-resolution")}z=y&&(typeof y==="object"||typeof y==="function")&&y.then;if(e(z)){if(r){z.call(y,m(p,q,a,r),m(p,q,f,r))}else{p++;z.call(y,m(p,q,a,r),m(p,q,f,r),m(p,q,a,q.notifyWith))}}else{if(s!==a){v=undefined;u=[y]}(r||q.resolveWith)(v,u)}},x=r?w:function(){try{w()}catch(y){if(c.Deferred.exceptionHook){c.Deferred.exceptionHook(y,x.stackTrace)}if(t+1>=p){if(s!==f){v=undefined;u=[y]}q.rejectWith(v,u)}}};if(t){x()}else{if(c.Deferred.getStackHook){x.stackTrace=c.Deferred.getStackHook()}window.setTimeout(x)}}}return c.Deferred(function(q){h[0][3].add(m(0,q,e(n)?n:a,q.notifyWith));h[1][3].add(m(0,q,e(o)?o:a));h[2][3].add(m(0,q,e(l)?l:f))}).promise()},promise:function(l){return l!=null?c.extend(l,k):k}},g={};c.each(h,function(m,l){var o=l[2],n=l[5];k[l[1]]=o.add;if(n){o.add(function(){j=n},h[3-m][2].disable,h[3-m][3].disable,h[0][2].lock,h[0][3].lock)}o.add(l[3].fire);g[l[0]]=function(){g[l[0]+"With"](this===g?undefined:this,arguments);return this};g[l[0]+"With"]=o.fireWith});k.promise(g);if(i){i.call(g,g)}return g},when:function(h){var l=arguments.length,j=l,k=Array(j),n=d.call(arguments),m=c.Deferred(),g=function(o){return function(i){k[o]=this;n[o]=arguments.length>1?d.call(arguments):i;if(!(--l)){m.resolveWith(k,n)}}};if(l<=1){b(h,m.done(g(j)).resolve,m.reject,!l);if(m.state()==="pending"||e(n[j]&&n[j].then)){return m.then()}}while(j--){b(n[j],g(j),m.reject)}return m.promise()}});return c});